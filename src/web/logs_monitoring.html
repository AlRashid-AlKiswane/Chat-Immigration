<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>System Monitor ‚Äì Canada Immigration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fff;
      margin: 0;
      color: #222;
    }
    header {
      background: linear-gradient(to right, #d32f2f, #f44336);
      color: white;
      text-align: center;
      padding: 1.5rem 1rem;
      font-size: 2rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .button-bar {
      text-align: center;
      margin: 1rem;
    }
    .button-bar button {
      padding: 0.5rem 1rem;
      background-color: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    .section-header {
      text-align: center;
      margin: 2rem auto 1rem;
      font-size: 1.4rem;
      color: #b71c1c;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 2rem;
      padding: 1rem;
      max-width: 1000px;
      margin: auto;
    }
    .card {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: #fafafa;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .card h2 {
      margin: 0.5rem 0 1rem;
      font-size: 1.2rem;
      color: #333;
    }
    .ring-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: auto;
    }
    .ring-container svg {
      transform: rotate(-90deg);
    }
    .percent-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.1rem;
      font-weight: bold;
      color: #222;
    }
    .info {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #666;
    }
    .low-color { stroke: #2e7d32; }
    .medium-color { stroke: #fbc02d; }
    .high-color { stroke: #d32f2f; }
    .na { stroke: #999; }
  </style>
</head>
<body>

  <header>üá®üá¶ Canada Immigration ‚Äì System Monitor</header>
  <div class="button-bar">
  </div>
  <div class="section-header">Live System Resources</div>
  <div class="grid" id="dashboardGrid"></div>

  <script>
    function getAuthToken() {
      return localStorage.getItem("token");
    }

    function redirectIfUnauthenticated() {
      if (!getAuthToken()) {
        window.location.href = "/login.html";
      }
    }

    function goBackToDashboard() {
      window.location.href = "/index.html";
    }

    const RADIUS = 50;
    const CIRCUMFERENCE = 2 * Math.PI * RADIUS;

    function getRingClass(percent, type = "default") {
      if (typeof percent !== "number") return "na";
      if (type === "battery") {
        if (percent >= 75) return "low-color";
        if (percent >= 50) return "medium-color";
        return "high-color";
      }
      if (percent < 50) return "low-color";
      if (percent < 75) return "medium-color";
      return "high-color";
    }

    function createRing(title, percent, infoText = "", type = "default") {
      if (typeof percent !== "number") {
        return `
          <div class="card">
            <h2>${title}</h2>
            <div class="ring-container">
              <div class="percent-label">N/A</div>
            </div>
          </div>`;
      }

      const strokeDash = CIRCUMFERENCE * (1 - percent / 100);
      const colorClass = getRingClass(percent, type);

      return `
        <div class="card">
          <h2>${title}</h2>
          <div class="ring-container">
            <svg width="120" height="120">
              <circle cx="60" cy="60" r="${RADIUS}" stroke="#eee" stroke-width="10" fill="none"/>
              <circle cx="60" cy="60" r="${RADIUS}" stroke-width="10"
                      fill="none" stroke-dasharray="${CIRCUMFERENCE}"
                      stroke-dashoffset="${strokeDash}" class="${colorClass}" />
            </svg>
            <div class="percent-label">${percent.toFixed(1)}%</div>
          </div>
          ${infoText ? `<div class="info">${infoText}</div>` : ""}
        </div>`;
    }

    async function loadMonitoringData() {
      const grid = document.getElementById("dashboardGrid");

      try {
        const res = await fetch("/api/v1/monitoring", {
          headers: { "Authorization": `Bearer ${getAuthToken()}` }
        });
        const json = await res.json();
        const data = json?.data || {};
        const cards = [];

        const cpu = data.cpu || {};
        cards.push(createRing("CPU", cpu.cpu_usage, cpu.cpu_temp ? `Temp: ${cpu.cpu_temp}¬∞C` : ""));

        const mem = data.memory || {};
        cards.push(createRing("Memory", mem.percent, mem.used && mem.total ? `${mem.used} / ${mem.total} MB` : ""));

        const disk = data.disk || {};
        const diskPercent = (disk.used && disk.total) ? (disk.used / disk.total) * 100 : undefined;
        cards.push(createRing("Disk", diskPercent, disk.used && disk.total ? `${disk.used} / ${disk.total} GB` : ""));

        const batt = data.battery || {};
        cards.push(createRing("Battery", batt.percent, batt.plugged_in !== undefined ? (batt.plugged_in ? "üîå Plugged In" : "üîã On Battery") : "", "battery"));

        grid.innerHTML = cards.join("");
      } catch (err) {
        grid.innerHTML = `<div class="card"><h2>Error</h2><div class="info">Failed to fetch system data.</div></div>`;
        console.error("Monitoring fetch error:", err);
      }
    }

    window.addEventListener("load", () => {
      redirectIfUnauthenticated();
      loadMonitoringData();
      setInterval(loadMonitoringData, 5000);
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>App Logs Viewer ‚Äì üá®üá¶ Canada Immigration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f5f7fa;
      color: #333;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: linear-gradient(to right, #d32f2f, #f44336);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .button-bar {
      text-align: center;
      margin: 0.5rem;
    }
    .button-bar button {
      padding: 0.5rem 1rem;
      background-color: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 900px;
      margin: auto;
      width: 100%;
    }
    form {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    input[type="number"], select {
      padding: 0.4rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button[type="submit"] {
      padding: 0.5rem 1.2rem;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
    }
    button[type="submit"]:hover {
      background: #b71c1c;
    }
    #logOutput {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: monospace;
      font-size: 0.9rem;
      padding: 1rem;
      border-radius: 6px;
      overflow-y: auto;
      height: 60vh;
      white-space: pre-wrap;
    }
    .log-error { color: #ff6b6b; font-weight: bold; }
    .log-info { color: #4dabf7; }
    .log-debug { color: #4caf50; font-style: italic; }
    #status {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #666;
    }
  </style>
</head>
<body>

  <header>üá®üá¶ Canada Immigration ‚Äì Application Logs Viewer</header>
  <main>
    <form id="logForm">
      <label for="linesInput">Lines:</label>
      <input type="number" id="linesInput" name="lines" placeholder="100" />
      <label for="modeSelect">Mode:</label>
      <select id="modeSelect">
        <option value="full">Full</option>
        <option value="head">Head</option>
        <option value="tail" selected>Tail</option>
      </select>
      <button type="submit">Fetch Logs</button>
    </form>
    <div id="status" role="status" aria-live="polite"></div>
    <pre id="logOutput" tabindex="0"></pre>
    <div class="button-bar">
    <button onclick="goBackToDashboard()">‚¨ÖÔ∏è Back to Dashboard</button>
  </div>
  </main>

  <script>
    function getAuthToken() {
      return localStorage.getItem("token");
    }

    function redirectIfUnauthenticated() {
      if (!getAuthToken()) {
        window.location.href = "/login.html";
      }
    }

    function goBackToDashboard() {
      window.location.href = "/index.html";
    }

    const form = document.getElementById("logForm");
    const logOutput = document.getElementById("logOutput");
    const statusEl = document.getElementById("status");
    const linesInput = document.getElementById("linesInput");
    const modeSelect = document.getElementById("modeSelect");

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c]));
    }

    function colorizeLogLines(text) {
      return text.split('\n').map(line => {
        const escaped = escapeHtml(line);
        if (/error/i.test(line)) return `<span class="log-error">${escaped}</span>`;
        if (/info/i.test(line)) return `<span class="log-info">${escaped}</span>`;
        if (/debug/i.test(line)) return `<span class="log-debug">${escaped}</span>`;
        return escaped;
      }).join('\n');
    }

    async function fetchLogs(lines, mode) {
      try {
        statusEl.textContent = "Loading logs...";
        const params = new URLSearchParams();
        if (mode !== "full") {
          if (!lines || lines <= 0) {
            statusEl.textContent = "Enter a positive number of lines.";
            return;
          }
          params.append("lines", lines);
          params.append("tail", mode === "tail" ? "true" : "false");
        }

        const res = await fetch(`/api/v1/logs?${params.toString()}`, {
          headers: { "Authorization": `Bearer ${getAuthToken()}` }
        });

        if (!res.ok) {
          statusEl.textContent = `Error ${res.status}: ${await res.text()}`;
          return;
        }

        const text = await res.text();
        logOutput.innerHTML = colorizeLogLines(text);
        statusEl.textContent = `Logs loaded (${mode}, ${lines || 'all'} lines).`;

        logOutput.scrollTop = mode === "tail" ? logOutput.scrollHeight : 0;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to fetch logs.";
      }
    }

    function refreshLogs() {
      const lines = parseInt(linesInput.value, 10);
      const mode = modeSelect.value;
      fetchLogs(lines, mode);
    }

    form.addEventListener("submit", e => {
      e.preventDefault();
      refreshLogs();
      clearInterval(window.logTimer);
      window.logTimer = setInterval(refreshLogs, 5000);
    });

    window.addEventListener("load", () => {
      redirectIfUnauthenticated();
      linesInput.value = 100;
      refreshLogs();
      window.logTimer = setInterval(refreshLogs, 5000);
    });
  </script>
</body>
</html>
